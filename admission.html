<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Tuyển Sinh Chi Tiết 2025-2026</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f3f4f6;
        }
        .navy-bg { background-color: #001f3f; }
        .navy-text { color: #001f3f; }
        .red-text { color: #dc3545; }
        .red-bg { background-color: #dc3545; }
        
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        .card-shadow:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Custom Scrollbar for crowded charts if needed */
        .chart-container {
            position: relative; 
            height: 400px; 
            width: 100%;
        }

        /* Table Styles */
        .table-header {
            background-color: #001f3f;
            color: white;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        
        .table-row:nth-child(even) {
            background-color: #f8fafc;
        }
        
        .table-row:hover {
            background-color: #e2e8f0;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: '#001f3f',
                        customRed: '#dc3545',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header Section -->
    <header class="navy-bg text-white p-6 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <div class="mb-4 md:mb-0">
                <h1 class="text-2xl md:text-3xl font-bold uppercase tracking-wide">
                    <i class="fa-solid fa-chart-line mr-2"></i> Báo Cáo Chi Tiết
                </h1>
                <p class="text-gray-300 text-sm mt-1">Tuyển Sinh Năm Học: 2025 - 2026 (Theo từng đơn vị)</p>
            </div>
            <div class="text-right">
                <button onclick="window.print()" class="bg-customRed hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300 shadow-md">
                    <i class="fa-solid fa-print mr-2"></i> Xuất PDF
                </button>
            </div>
        </div>
    </header>

    <div id="app" class="container mx-auto p-4 md:p-6 space-y-8">
        
        <!-- KPI Cards Global -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Total Students -->
            <div class="bg-white rounded-lg p-6 card-shadow border-l-4 border-navy">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Tổng Học Sinh</p>
                        <h2 class="text-3xl font-black navy-text mt-1" id="totalStudents">0</h2>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-full text-navy">
                        <i class="fa-solid fa-users text-xl"></i>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-500">
                    <span class="text-green-600 font-bold"><i class="fa-solid fa-school"></i> 12</span> Đơn vị hoạt động
                </div>
            </div>

            <!-- Total Revenue -->
            <div class="bg-white rounded-lg p-6 card-shadow border-l-4 border-customRed">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Tổng Doanh Thu</p>
                        <h2 class="text-2xl font-black text-customRed mt-1" id="totalRevenue">0</h2>
                    </div>
                    <div class="bg-red-50 p-3 rounded-full text-customRed">
                        <i class="fa-solid fa-sack-dollar text-xl"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2">Doanh thu thực thu (VND)</p>
            </div>

            <!-- Avg Occupancy -->
            <div class="bg-white rounded-lg p-6 card-shadow border-l-4 border-green-500">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Tỷ lệ Lấp đầy</p>
                        <h2 class="text-3xl font-black text-green-600 mt-1" id="avgOccupancy">0%</h2>
                    </div>
                    <div class="bg-green-50 p-3 rounded-full text-green-600">
                        <i class="fa-solid fa-percent text-xl"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2">Trung bình toàn hệ thống</p>
            </div>

             <!-- Top Unit -->
             <div class="bg-white rounded-lg p-6 card-shadow border-l-4 border-yellow-500">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Đơn Vị Dẫn Đầu</p>
                        <h2 class="text-sm font-bold text-yellow-700 mt-1 truncate w-40" id="topUnitName">N/A</h2>
                        <p class="text-lg font-black text-yellow-600" id="topUnitRev">0</p>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-full text-yellow-600">
                        <i class="fa-solid fa-crown text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenue Analysis Charts Row (New) -->
         <div>
            <h3 class="text-lg font-bold navy-text mb-4 border-l-4 border-navy pl-2 uppercase">Phân Tích Cơ Cấu Doanh Thu</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <!-- Revenue Source Chart -->
                <div class="bg-white p-6 rounded-lg card-shadow">
                    <h3 class="text-sm font-bold text-gray-500 mb-2 text-center uppercase">Doanh Thu: HS Cũ vs HS Mới</h3>
                    <div class="flex justify-center h-56">
                        <canvas id="revenueSourceChart"></canvas>
                    </div>
                    <div class="mt-2 text-center text-xs text-gray-400">
                        Tỷ trọng đóng góp vào tổng doanh thu
                    </div>
                </div>

                <!-- Revenue by Level Chart -->
                <div class="bg-white p-6 rounded-lg card-shadow">
                    <h3 class="text-sm font-bold text-gray-500 mb-2 text-center uppercase">Tỷ Trọng Doanh Thu Theo Cấp</h3>
                    <div class="flex justify-center h-56">
                        <canvas id="revenueLevelChart"></canvas>
                    </div>
                     <div class="mt-2 text-center text-xs text-gray-400">
                        Cấp học nào mang lại doanh thu chính?
                    </div>
                </div>

                 <!-- Student by Level Chart (Existing but moved here for symmetry) -->
                 <div class="bg-white p-6 rounded-lg card-shadow">
                    <h3 class="text-sm font-bold text-gray-500 mb-2 text-center uppercase">Tỷ Trọng Số Lượng Học Sinh</h3>
                    <div class="flex justify-center h-56">
                        <canvas id="studentLevelChart"></canvas>
                    </div>
                     <div class="mt-2 text-center text-xs text-gray-400">
                        Phân bổ quy mô học sinh
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Detailed Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Revenue Chart (Detailed) -->
            <div class="bg-white p-6 rounded-lg card-shadow lg:col-span-2">
                <h3 class="text-lg font-bold navy-text mb-4 border-b pb-2 flex items-center">
                    <i class="fa-solid fa-chart-column mr-2"></i> Xếp Hạng Doanh Thu Theo Đơn Vị
                </h3>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!-- Capacity vs Actual Chart -->
             <div class="bg-white p-6 rounded-lg card-shadow">
                <h3 class="text-lg font-bold navy-text mb-4 border-b pb-2 flex items-center">
                    <i class="fa-solid fa-sliders mr-2"></i> Hiệu Suất (Công Suất vs Thực Tế)
                </h3>
                <div class="w-full h-80">
                    <canvas id="capacityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed List (Cards) -->
        <div>
            <div class="flex justify-between items-end mb-6 border-b border-gray-300 pb-2">
                <h3 class="text-2xl font-bold navy-text border-l-8 border-customRed pl-3">
                    Thẻ Chi Tiết Từng Cơ Sở
                </h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="facilityGrid">
                <!-- Javascript will inject cards here -->
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="mt-12">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold navy-text border-l-8 border-navy pl-3">
                    Bảng Kê Chi Tiết Doanh Thu & Chỉ Số
                </h3>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg overflow-hidden border border-gray-200">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="table-header">
                            <tr>
                                <th class="px-6 py-4">STT</th>
                                <th class="px-6 py-4">Cơ sở</th>
                                <th class="px-6 py-4">Cấp học</th>
                                <th class="px-6 py-4 text-right">HS Thực tế</th>
                                <th class="px-6 py-4 text-right">Công suất</th>
                                <th class="px-6 py-4 text-center">% Lấp đầy</th>
                                <th class="px-6 py-4 text-right">Doanh thu (VND)</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="text-gray-700 font-medium">
                            <!-- Rows will be injected here -->
                        </tbody>
                        <tfoot class="bg-gray-100 font-bold text-gray-900 border-t-2 border-navy">
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-right uppercase tracking-wider">Tổng cộng toàn hệ thống</td>
                                <td class="px-6 py-4 text-right" id="tableTotalStudents">0</td>
                                <td class="px-6 py-4 text-right" id="tableTotalCapacity">0</td>
                                <td class="px-6 py-4 text-center" id="tableAvgOccupancy">0%</td>
                                <td class="px-6 py-4 text-right text-customRed text-lg" id="tableTotalRevenue">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="navy-bg text-white text-center p-8 mt-12">
        <p class="font-bold text-lg">HỆ THỐNG QUẢN TRỊ DỮ LIỆU TUYỂN SINH</p>
        <p class="text-sm opacity-70 mt-2">Dữ liệu được cập nhật mới nhất cho năm học 2025-2026</p>
    </footer>

    <!-- Script Logic -->
    <script>
        // --- 1. DATA PREPARATION (RAW) ---
        // Đã cập nhật thêm trường oldRevenue (Doanh thu HS cũ) dựa trên dữ liệu PDF
        const rawData = [
            { id: 1, facility: "VA Bình Thới", level: "Tiểu học", students: 398, capacity: 528, revenue: 40539223603, oldRevenue: 36879682175 },
            { id: 1, facility: "VA Bình Thới", level: "THCS", students: 256, capacity: 396, revenue: 31448228487, oldRevenue: 30303631047 },
            { id: 1, facility: "VA Bình Thới", level: "THPT", students: 132, capacity: 264, revenue: 21585753229, oldRevenue: 20428702539 },
            { id: 1, facility: "VA Bình Thới", level: "Mầm non", students: 99, capacity: 119, revenue: 8419961800, oldRevenue: 6735969440 }, // Ước tính dựa trên tỷ lệ trung bình vì thiếu data chi tiết
            
            { id: 2, facility: "VA Tân Bình", level: "Tiểu học", students: 374, capacity: 450, revenue: 37109119818, oldRevenue: 27981450083 },
            { id: 2, facility: "VA Tân Bình", level: "THCS", students: 199, capacity: 325, revenue: 22917325633, oldRevenue: 20621786075 },
            
            { id: 3, facility: "VA Phú Định", level: "Tiểu học", students: 68, capacity: 225, revenue: 4907939055, oldRevenue: 3926351244 }, // Est 80%
            { id: 3, facility: "VA Phú Định", level: "Mầm non", students: 28, capacity: 136, revenue: 1322427200, oldRevenue: 1057941760 }, // Est 80%
            
            { id: 4, facility: "VA Thông Tây Hội", level: "Tiểu học", students: 77, capacity: 175, revenue: 5915792848, oldRevenue: 4732634278 }, // Est 80%
            
            { id: 6, facility: "VA Hòa Bình", level: "Mầm non", students: 45, capacity: 90, revenue: 1414155200, oldRevenue: 1131324160 }, // Est 80%
            
            { id: 7, facility: "VA Vĩnh Hội", level: "Mầm non", students: 78, capacity: 144, revenue: 5194673100, oldRevenue: 4155738480 }, // Est 80%
            
            { id: 9, facility: "VA Hạnh Thông", level: "Mầm non", students: 64, capacity: 135, revenue: 1073002500, oldRevenue: 858402000 } // Est 80%
        ];

        // --- 2. HELPERS ---
        function formatMoney(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 }).format(amount);
        }

        function formatMoneyShort(amount) {
            if (amount >= 1000000000) {
                return (amount / 1000000000).toFixed(1) + ' Tỷ';
            }
            return (amount / 1000000).toFixed(0) + ' Tr';
        }

        // Tạo tên hiển thị đầy đủ
        rawData.forEach(item => {
            item.fullName = `${item.facility} - ${item.level}`;
            item.occupancy = ((item.students / item.capacity) * 100).toFixed(1);
            // Calculate New Revenue
            item.newRevenue = item.revenue - item.oldRevenue;
        });

        // Sắp xếp dữ liệu theo ID rồi đến cấp học để hiển thị trong Bảng cho đẹp (như Excel)
        const tableData = [...rawData].sort((a, b) => {
            if (a.id !== b.id) return a.id - b.id;
            return a.level.localeCompare(b.level);
        });
        
        const sortedData = [...rawData].sort((a, b) => b.revenue - a.revenue);

        // --- 3. KPI CALCULATIONS ---
        const totalStudents = rawData.reduce((sum, item) => sum + item.students, 0);
        const totalRevenue = rawData.reduce((sum, item) => sum + item.revenue, 0);
        const totalCapacity = rawData.reduce((sum, item) => sum + item.capacity, 0);
        const totalOldRevenue = rawData.reduce((sum, item) => sum + item.oldRevenue, 0);
        const totalNewRevenue = totalRevenue - totalOldRevenue;
        
        const avgOccupancy = ((totalStudents / totalCapacity) * 100).toFixed(1);
        
        const topUnit = sortedData[0];

        // Render KPIs
        document.getElementById('totalStudents').innerText = totalStudents.toLocaleString('vi-VN');
        document.getElementById('totalRevenue').innerText = formatMoneyShort(totalRevenue);
        document.getElementById('avgOccupancy').innerText = avgOccupancy + '%';
        document.getElementById('topUnitName').innerText = topUnit.fullName;
        document.getElementById('topUnitRev').innerText = formatMoneyShort(topUnit.revenue);

        // --- 4. RENDER CARDS (GRID) ---
        const facilityGrid = document.getElementById('facilityGrid');
        
        sortedData.forEach(item => {
            // Determine Color Status
            let statusColor = 'bg-green-500';
            let statusText = 'Tốt';
            
            if(item.occupancy < 50) {
                statusColor = 'bg-red-500';
                statusText = 'Thấp';
            } else if (item.occupancy < 75) {
                statusColor = 'bg-yellow-500';
                statusText = 'Trung bình';
            }

            // Create Card HTML
            const card = document.createElement('div');
            card.className = `bg-white rounded-lg p-5 card-shadow flex flex-col justify-between border-t-4 ${item.occupancy < 50 ? 'border-red-500' : 'border-navy'}`;
            
            card.innerHTML = `
                <div>
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-xs uppercase font-bold text-gray-400 tracking-wider">${item.level}</span>
                            <h4 class="text-lg font-bold navy-text leading-tight">${item.facility}</h4>
                        </div>
                        <span class="${statusColor} text-white text-xs font-bold px-2 py-1 rounded">
                            ${statusText}
                        </span>
                    </div>
                    
                    <div class="mt-4">
                        <div class="flex justify-between text-sm mb-1 text-gray-600">
                            <span>Đã tuyển: <b>${item.students}</b></span>
                            <span>Sức chứa: ${item.capacity}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="${statusColor} h-3 rounded-full" style="width: ${item.occupancy}%"></div>
                        </div>
                        <div class="text-right text-xs font-bold mt-1 ${item.occupancy < 50 ? 'text-red-500' : 'text-green-600'}">
                            ${item.occupancy}% Lấp đầy
                        </div>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-dashed border-gray-200">
                    <div class="flex justify-between items-end">
                        <span class="text-gray-500 text-sm">Doanh thu:</span>
                        <span class="text-xl font-black text-customRed">${formatMoneyShort(item.revenue)}</span>
                    </div>
                </div>
            `;
            facilityGrid.appendChild(card);
        });

        // --- 5. RENDER TABLE ---
        const tableBody = document.getElementById('dataTableBody');
        tableData.forEach((item, index) => {
            const row = document.createElement('tr');
            row.className = 'table-row border-b border-gray-200';
            
            // Occupancy styling
            let occColor = 'text-green-600';
            if(item.occupancy < 50) occColor = 'text-red-600';
            else if(item.occupancy < 75) occColor = 'text-yellow-600';

            row.innerHTML = `
                <td class="px-6 py-4 text-center text-gray-500">${item.id}</td>
                <td class="px-6 py-4 font-bold navy-text">${item.facility}</td>
                <td class="px-6 py-4"><span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs font-bold uppercase">${item.level}</span></td>
                <td class="px-6 py-4 text-right">${item.students.toLocaleString('vi-VN')}</td>
                <td class="px-6 py-4 text-right">${item.capacity.toLocaleString('vi-VN')}</td>
                <td class="px-6 py-4 text-center font-bold ${occColor}">${item.occupancy}%</td>
                <td class="px-6 py-4 text-right font-mono">${formatMoney(item.revenue)}</td>
            `;
            tableBody.appendChild(row);
        });

        // Update Footer Totals in Table
        document.getElementById('tableTotalStudents').innerText = totalStudents.toLocaleString('vi-VN');
        document.getElementById('tableTotalCapacity').innerText = totalCapacity.toLocaleString('vi-VN');
        document.getElementById('tableAvgOccupancy').innerText = avgOccupancy + '%';
        document.getElementById('tableTotalRevenue').innerText = formatMoney(totalRevenue);

        // --- 6. CHARTS ---

        // Config chung cho font
        Chart.defaults.font.family = "'Roboto', sans-serif";
        Chart.defaults.color = '#4b5563';

        // Chart 1: Revenue by Unit (Bar Chart)
        const ctxRev = document.getElementById('revenueChart').getContext('2d');
        new Chart(ctxRev, {
            type: 'bar',
            data: {
                labels: sortedData.map(d => d.fullName),
                datasets: [{
                    label: 'Doanh thu (VND)',
                    data: sortedData.map(d => d.revenue),
                    backgroundColor: sortedData.map(d => d.level === 'Tiểu học' ? '#001f3f' : (d.level === 'THCS' ? '#dc3545' : '#17a2b8')), 
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'x', // Vertical bars
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: { label: (ctx) => formatMoneyShort(ctx.raw) }
                    }
                },
                scales: {
                    x: { ticks: { maxRotation: 45, minRotation: 45, font: {size: 10} } },
                    y: { ticks: { callback: (val) => formatMoneyShort(val) }, beginAtZero: true }
                }
            }
        });

        // Chart 2: Capacity vs Actual (Combo Chart)
        const ctxCap = document.getElementById('capacityChart').getContext('2d');
        new Chart(ctxCap, {
            type: 'bar',
            data: {
                labels: sortedData.map(d => d.fullName), // Use same sorted order
                datasets: [
                    {
                        label: 'Thực tế tuyển sinh',
                        data: sortedData.map(d => d.students),
                        backgroundColor: '#dc3545',
                        barPercentage: 0.6,
                        order: 2
                    },
                    {
                        label: 'Tổng công suất',
                        data: sortedData.map(d => d.capacity),
                        type: 'line',
                        borderColor: '#001f3f',
                        borderWidth: 2,
                        pointStyle: 'circle',
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        tension: 0.1,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: { ticks: { display: false } }, 
                    y: { beginAtZero: true }
                }
            }
        });

        // --- NEW CHARTS START HERE ---

        // Chart 3: Student Level Distribution (Aggregated Doughnut - Quantity)
        const levels = {};
        rawData.forEach(item => {
            if (!levels[item.level]) levels[item.level] = 0;
            levels[item.level] += item.students;
        });
        
        const ctxStudentLevel = document.getElementById('studentLevelChart').getContext('2d');
        new Chart(ctxStudentLevel, {
            type: 'doughnut',
            data: {
                labels: Object.keys(levels),
                datasets: [{
                    data: Object.values(levels),
                    backgroundColor: ['#001f3f', '#dc3545', '#ffc107', '#17a2b8'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, font: {size: 11} } }
                }
            }
        });

        // Chart 4: Revenue Source (Old vs New)
        const ctxRevSource = document.getElementById('revenueSourceChart').getContext('2d');
        new Chart(ctxRevSource, {
            type: 'pie',
            data: {
                labels: ['Học sinh cũ (Gia hạn)', 'Học sinh mới (Tuyển mới)'],
                datasets: [{
                    data: [totalOldRevenue, totalNewRevenue],
                    backgroundColor: ['#001f3f', '#dc3545'], // Navy (Old) vs Red (New)
                    borderWidth: 1,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, font: {size: 11} } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                let value = context.parsed;
                                let total = context.chart._metasets[context.datasetIndex].total;
                                let percentage = ((value / total) * 100).toFixed(1) + "%";
                                return label + formatMoneyShort(value) + ' (' + percentage + ')';
                            }
                        }
                    }
                }
            }
        });

        // Chart 5: Revenue By Level (Money Share)
        const levelRevenues = {};
        rawData.forEach(item => {
            if (!levelRevenues[item.level]) levelRevenues[item.level] = 0;
            levelRevenues[item.level] += item.revenue;
        });

        const ctxRevLevel = document.getElementById('revenueLevelChart').getContext('2d');
        new Chart(ctxRevLevel, {
            type: 'doughnut',
            data: {
                labels: Object.keys(levelRevenues),
                datasets: [{
                    data: Object.values(levelRevenues),
                    backgroundColor: ['#001f3f', '#dc3545', '#ffc107', '#17a2b8'], // Navy, Red, Yellow, Teal
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, font: {size: 11} } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                let value = context.parsed;
                                return label + formatMoneyShort(value);
                            }
                        }
                    }
                }
            }
        });

    </script>
</body>
</html>
